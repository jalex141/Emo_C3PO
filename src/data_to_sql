


def check(que,string):
    """
    Función parametrizada que comprueba en cada tabla si existe el user, artista o canción.
    Devuelve True si existe y False si no
    """
    if que == "characters":
        query = list(engine.execute(f"SELECT name FROM character WHERE name = '{string}'"))
        if len(query) > 0:
            return True
        else:
            return False
        
    elif que == "lines":
        query = list(engine.execute(f"SELECT line FROM lines WHERE line = '{string}'"))
        if len(query) > 0:
            return True
        else:
            return False
    
    elif que == "episodes":
        query = list(engine.execute(f"SELECT episode FROM episodes WHERE episode = '{string}'"))
        if len(query) > 0:
            return True
        else:
            return False


def insertCharacter(string):
    """
    Llama a la función check para comprobar si existe el ironhacker
    Inserta ironhacker si no existe
    """
    if check("character", string):
        return "character exists"
    else:
        engine.execute(f"INSERT INTO characters (character) VALUES ('{string}');")


def insertEpisode(ep):
    """
    Llama a la función check para comprobar si existe el artista
    Inserta artista si no existe
    """
    if check("episode", ep):
        return "episode exists"
    else:
        engine.execute(f"INSERT INTO episodes (episode) VALUES ('{ep}');")

def giveId(que,string):
    """
    Devuelve el ID de lo que le pidamos sabiendo que ese elemento EXISTE
    """
    if que == "characters":
        return list(engine.execute(f"SELECT char_id FROM characters WHERE character ='{string}';"))[0][0]
    elif que == "episodes":
        return list(engine.execute(f"SELECT ep_id FROM episodes WHERE episode ='{string}';"))[0][0]


def insertLine(row):
    """
    La función final 
    """
    if check("lines", row["dialogue"]):
        return "line exists"
    else:
        if check("characters", row["character"]):
            char_id = giveId("characters", row["character"])
        else:
            insertCharacter(row["character"])
            char_id = giveId("characters", row["character"])
        
        if check("episodes", row["episode"]):
            ep_id = giveId("episodes", row["episode"])
        else:
            insertEpisode(row["episode"])
            ep_id = giveId("episodes", row["episode"])
            
        engine.execute(f"""
        INSERT INTO lines (line_n, char_id, line, ep_id, meme_id) VALUES
        ("{row['line']}", "{char_id}", "{row['dialogue']}", "{ep_id}", "{meme_id}");
        """)

